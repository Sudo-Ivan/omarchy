FROM archlinux:latest

# Initialize pacman keyring and update system
RUN pacman-key --init && \
    pacman-key --populate archlinux && \
    pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget base-devel sudo haveged

# Start entropy daemon for GPG operations
RUN systemctl enable haveged || true

# Create test user
RUN useradd -m -G wheel testuser && \
    echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers

USER testuser
WORKDIR /home/testuser

RUN echo "%echo Generating test key" > /tmp/gpg-batch && \
    echo "Key-Type: RSA" >> /tmp/gpg-batch && \
    echo "Key-Length: 2048" >> /tmp/gpg-batch && \
    echo "Name-Real: Test User" >> /tmp/gpg-batch && \
    echo "Name-Email: test@example.com" >> /tmp/gpg-batch && \
    echo "Expire-Date: 0" >> /tmp/gpg-batch && \
    echo "%no-protection" >> /tmp/gpg-batch && \
    echo "%commit" >> /tmp/gpg-batch && \
    echo "%echo done" >> /tmp/gpg-batch && \
    gpg --batch --gen-key /tmp/gpg-batch && \
    rm /tmp/gpg-batch

COPY . /home/testuser/omarchy-test

CMD ["/bin/bash", "-c", "cd /home/testuser && curl -s https://raw.githubusercontent.com/Sudo-Ivan/omarchy/refs/heads/master/boot.sh | bash && echo 'Omarchy installation test completed'"]
