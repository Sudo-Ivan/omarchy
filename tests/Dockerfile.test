FROM archlinux:latest

# Initialize pacman keyring and update system
RUN pacman-key --init && \
    pacman-key --populate archlinux && \
    pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget base-devel sudo haveged

# Create test user
RUN useradd -m -G wheel testuser && \
    echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers

# Create mock systemctl to prevent failures
RUN echo '#!/bin/bash' > /usr/local/bin/systemctl && \
    echo 'echo "Mock systemctl: $@"' >> /usr/local/bin/systemctl && \
    echo 'exit 0' >> /usr/local/bin/systemctl && \
    chmod +x /usr/local/bin/systemctl && \
    ln -sf /usr/local/bin/systemctl /usr/bin/systemctl

# Create mock usermod to prevent failures
RUN echo '#!/bin/bash' > /usr/local/bin/usermod && \
    echo 'echo "Mock usermod: $@"' >> /usr/local/bin/usermod && \
    echo 'exit 0' >> /usr/local/bin/usermod && \
    chmod +x /usr/local/bin/usermod && \
    ln -sf /usr/local/bin/usermod /usr/bin/usermod

# Create mock powerprofilesctl to prevent power management failures
RUN echo '#!/bin/bash' > /usr/local/bin/powerprofilesctl && \
    echo 'echo "Mock powerprofilesctl: $@"' >> /usr/local/bin/powerprofilesctl && \
    echo 'exit 0' >> /usr/local/bin/powerprofilesctl && \
    chmod +x /usr/local/bin/powerprofilesctl && \
    ln -sf /usr/local/bin/powerprofilesctl /usr/bin/powerprofilesctl

# Prevent sudoers syntax issues by pre-creating the problematic files
RUN mkdir -p /etc/sudoers.d && \
    echo "testuser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/testuser && \
    echo "testuser ALL=(ALL) NOPASSWD: /usr/local/bin/asdcontrol" > /etc/sudoers.d/asdcontrol && \
    chmod 440 /etc/sudoers.d/asdcontrol

# Switch to testuser and set USER environment
USER testuser
WORKDIR /home/testuser
ENV USER=testuser

# Initialize user GPG if needed
RUN echo "%echo Generating test key" > /tmp/gpg-batch && \
    echo "Key-Type: RSA" >> /tmp/gpg-batch && \
    echo "Key-Length: 2048" >> /tmp/gpg-batch && \
    echo "Name-Real: Test User" >> /tmp/gpg-batch && \
    echo "Name-Email: test@example.com" >> /tmp/gpg-batch && \
    echo "Expire-Date: 0" >> /tmp/gpg-batch && \
    echo "%no-protection" >> /tmp/gpg-batch && \
    echo "%commit" >> /tmp/gpg-batch && \
    echo "%echo done" >> /tmp/gpg-batch && \
    gpg --batch --gen-key /tmp/gpg-batch && \
    rm /tmp/gpg-batch

COPY . /home/testuser/omarchy-test

# Run installation with proper environment
CMD ["/bin/bash", "-c", "cd /home/testuser && curl -s https://raw.githubusercontent.com/Sudo-Ivan/omarchy/refs/heads/master/boot.sh | bash && echo 'Omarchy installation test completed'"]
